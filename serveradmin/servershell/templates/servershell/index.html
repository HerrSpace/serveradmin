{% extends "base.html" %}
{% load url from future %}
{% load serversearch %}
{% block title %}Servershell{% endblock %}

{% block content %}
<h2>Servershell</h2>

<table class="valign-middle">
<tr>
    <td>Search: </td>
    <td>
        <form method="post" action="" id="shell_search_form">
        {% csrf_token %}
        <input type="text" size="60"  id="shell_search" value="{{ search_term }}" />
        </form>
    </td>
    <td>
        <a href="?term=" id="shell_search_link">
            <img src="{{ STATIC_URL }}link.png" alt="Link to this search" 
                title="Link to this search" />
        </a>
        <img src="{{ STATIC_URL}}help.png" id="shell_search_help_icon"
        alt="Help" class="help_icon" />
    {% comment %}
        <img src="{{ STATIC_URL}}bookmarked.png" id="shell_bookmarked" />
        <img src="{{ STATIC_URL}}notbookmarked.png" id="shell_notbookmarked" />
    {% endcomment %}
    </td>
</tr>
<tr id="shell_understood_container">
    <td>Understood: </td>
    <td colspan="2" id="shell_understood">Nothing yet.</td>
</tr>
<tr id="shell_command_container">
    <td>Command: </td>
    <td>
        <form method="post" action="javascript:return false;" id="shell_command_form">
        <input type="text" size="60"  id="shell_command" />
        </form>
    </td>
    <td>
        <img src="{{ STATIC_URL}}help.png" id="shell_command_help_icon"
        alt="Help" class="help_icon" />
    </td>
</tr>
</table>

<div id="shell_servers"></div>
<div id="shell_attributes">
    <h3>Attributes <span id="shell_attributes_toggle">(hide)</span></h3>
    <ul>
    {% for attr in attribute_list %}
        <li data-attr="{{ attr }}">
        <label>
                <input type="checkbox" name="attr" value="{{ attr }}" {% if attr == 'all_ips' %}disabled="disabled" {% endif %}{% if attr in checked_attributes %}checked="checked" {% endif %}/>
            {{ attr }}
        </label>
        </li>
    {% endfor %}
    </ul>
</div>

<div id="shell_search_help" title="Search help">
<h3>Queries</h3>
<p>Queries contain several attribute conditions which are implicitly ANDed.
The conditions have the form <code>attr_name=filter_or_value</code>, for
example <code>os=squeeze</code> (with a value) or <code>os=any(lenny squeeze)</code>
(with the "any" filter). Attribute conditions are separated by spaces.</p>

<p>Filters start with a name followed by a "(", followed by arguments
and finally followed by ")". It's like function calls in most programming
languages. The arguments are <i>separated by space, not comma</i></p>

<p>Values are automatically typecasted according to the type of the attribute.
This means <code>all_ips=between(10.16.1.3 10.16.1.17)</code> doesn't do
string comparison, but comparison based on IP semantics. Also
you don't need quotes around strings, unless your string contains spaces
or other quotes.</p>

<p>There is also a shortcut for hostname searches. Instead of using
attribute condition you just have to type the hostname. If your hostname
contains parts of a regular expression (for example ".*", "[", "]")
it will be interpreted as regular expression.</p>

<h3>Examples</h3>
<p>Find Grepolis servers of Germany and France: <br />
<code>servertype=gp game_market=any(de fr)</code></p>

<p>Find Tribal Wars webservers in Germany for worlds 20-30: <br />
<code>servertype=ds game_function=web game_world=between(20 30)</code>

<p>Find Tribal Wars servers for worlds 10-20 and 60-70: <br />
<code>servertype=ds game_world=or(between(10 20) between(60 70))</code></p>

<p>Hostname matches ".*\.tr": <br />
<code>hostname=Regexp(.*\.tr)</code> <i>or just</i> <code>.*\.tr</code></p>

<h3>Available filters</h3>
<table>
    <tr>
        <th>Name</th>
        <th style="width:10em;">Arguments</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>Regexp</td>
        <td>posix_regexp</td>
        <td>Matches the attribute against a regular expression</td>
    </tr>
    <tr>
        <td>Comparison</td>
        <td>operator, value</td>
        <td>Compares an attribute against a value. Example:
            <code>game_world=Comparison(&gt; 20)</code>
        </td>
    </tr>
    <tr>
        <td>Any</td>
        <td>value[, value[, ...]]</td>
        <td>Checks if an attribute has any of the given values.
            Similar to SQL-IN. Example: <code>game_market=Any(de fr en)</code>
        </td>
    </tr>
    <tr>
        <td>Between</td>
        <td>start, stop</td>
        <td>Checks if an attribute is between <i>start</i> and <i>stop</i>
            (inclusive).
        </td>
    </tr>
    <tr>
        <td>InsideNetwork</td>
        <td>network</td>
        <td>Checks if an IP is inside a network. Network can be given in CIDR
            notation or as name of a defined IP range.
        </td>
    </tr>
    <tr>
        <td>InsideNetwork6</td>
        <td>network</td>
        <td>Checks if an IPv6 is inside a network. Network can be given in CIDR
            notation or as name of a defined IP range.
        </td>
    </tr>
    <tr>
        <td>PublicIP</td>
        <td><i>No args</i></td>
        <td>Checks if an IP is a public IP</td>
    </tr>
    <tr>
        <td>PrivateIP</td>
        <td><i>No args</i></td>
        <td>Checks if an IP is a private IP</td>
    </tr>
    <tr>
        <td>And</td>
        <td>filter[, filter[, ...]]</td>
        <td>Checks if ALL given filters are true.</td>
    </tr>
    <tr>
        <td>Or</td>
        <td>filter[, filter[, ...]]</td>
        <td>Checks if at least one of the given filter is true.</td>
    </tr>
    <tr>
        <td>Not</td>
        <td>filter</td>
        <td>Negates the given filter.</td>
    </tr>
    <tr>
        <td>Optional</td>
        <td>filter</td>
        <td>Normally all filters evaluate to False if the attribute does not
            exist on the server. By wrapping them into <i>Optional</i> the
            filter will evaluate to True if the attribute is not set and
            otherweise evaluate as it would do normally.
        </td>
    </tr>
</table>

</div>
<div id="shell_command_help" title="Command help">
<table>
    <tr>
        <th>Command</th>
        <th>Arguments</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>search</td>
        <td><span class="noargs">none</span></td>
        <td>Focus search field</td>
    </tr>
    <tr>
        <td>next</td>
        <td><span class="noargs">none</span></td>
        <td>Go the the next page.</td>
    </tr>
    <tr>
        <td>prev</td>
        <td><span class="noargs">none</span></td>
        <td>Go the the previous page.</td>
    </tr>
    <tr>
        <td>goto</td>
        <td>page_number</td>
        <td>Goto specified page.</td>
    </tr>
    <tr>
        <td>perpage</td>
        <td>number</td>
        <td>Show <i>number</i> hosts per page. Example: "<code>perpage 50</code>"</td>
    </tr>
    <tr>
        <td>attr</td>
        <td>attr_name[&nbsp;...]</td>
        <td>Show one or more attribute(s) in the server table. If it is already
            shown, it will be hidden. The attribute "all_ips" is a virtual one
            - it can't be used here. Example: "<code>attr os game_function</code>".
        </td>
    </tr>
    <tr>
        <td>orderby</td>
        <td>attr_name[&nbsp;asc|desc]</td>
        <td>Order the result by given attribute. This can be either ascending
            (asc) or descanding (desc). Multi attributes will be ordered in a
            special way: If no filtering is used, it orders by the minimum
            value on ascending and maximum on descending. If filtering is used,
            it takes the minimum/maximum value <em>which matches the filter</em>.
            Example: "<code>orderby game_market asc</code>".
        </td>
    </tr>
    <tr>
        <td>export</td>
        <td><span class="noargs">none</span></td>
        <td>Export servers as list of hostnames. This will open a dialog with
        a textbox containing the hostnames separated by spaces.
        </td>
    </tr>
    <tr>
        <td>selectall</td>
        <td><span class="noargs">none</span></td>
        <td>Select all servers on this page.
        </td>
    </tr>
    <tr>
        <td>unselectall</td>
        <td><span class="noargs">none</span></td>
        <td>Unselect all servers on this page.
        </td>
    </tr>
    <tr>
        <td><i>(empty)</i></td>
        <td><i>from</i>[-<i>to</i>[, <i>from</i>[-<i>to</i>]]]</td>
        <td><p>Select a several servers using a range. Examples:</p>
            <ul>
                <li>1: Select first server</li>
                <li>1,3,5: Select server 1, 3 and 5</li>
                <li>1,3,6-9: Select server 1, 3, 6, 7, 8 and 9</li>
            </ul>
        </td>
    </tr>
    <tr>
        <td>graph</td>
        <td><span class="noargs">none</span></td>
        <td>Show available servermonitor graphs for selected hosts. If no host
        is selected, it will show graphs for the first host in the list.
        </td>
    </tr>
    <tr>
        <td>livegraph</td>
        <td><span class="noargs">none</span></td>
        <td>Show live graphs for the selected hosts. If no host
        is selected, it will show graphs for the first host in the list.
        </td>
    </tr>
    <tr>
        <td>cmp</td>
        <td>[graph[, graph ...]]</td>
        <td>Compares the given graphs of the selected hosts. If no graphs are
            given it compares all available graphs.
        </td>
    </tr>
    <tr>
        <td>list</td>
        <td><span class="noargs">none</span></td>
        <td>List all attributes of the selected servers. If no servers are
            selected, it takes the first one.
        </td>
    </tr>
    <tr>
        <td>setattr</td>
        <td>attr_name=attr_value</td>
        <td>Set an attribute on a server. Example: "setattr os=wheezy"</td>
    </tr>
    <tr>
        <td>delattr</td>
        <td>attr_name</td>
        <td>Delete an attribute from a server.</td>
    </tr>
    <tr>
        <td>multiadd</td>
        <td>attr_name=value1[,value2[,...]]</td>
        <td>Add values to an multi attribute. Example: "multiadd
            webserver=nginx,apache".
        </td>
    </tr>
    <tr>
        <td>multidel</td>
        <td>attr_name=value1[,value2[,...]</td>
        <td>Delete values from a multi attribute.
        </td>
    </tr>
    <tr>
        <td>delete</td>
        <td><span class="noargs">none</span></td>
        <td>Mark all selected servers for deletion. Commit to apply.
        </td>
    </tr>
    <tr>
        <td>commit</td>
        <td><span class="noargs">none</span></td>
        <td>Commit all pending changes.
        </td>
    </tr>
    <tr>
        <td>new</td>
        <td><span class="noargs">none</span>
        <td>Create a new server.</td>
    </tr>
    <tr>
        <td>clone</td>
        <td><span class="noargs">none</span>
        <td>Clone the selected server.</td>
    </tr>
    <tr>
        <td>changes</td>
        <td><span class="noargs">none</span>
        <td>Show changes to server database.</td>
    </tr>
    <tr>
        <td>history</td>
        <td><span class="noargs">none</span>
        <td>Show history of selected hosts.</td>
    </tr>
</table>
</div>


{% endblock %}

{% block additional_body %}
{% serversearch_js 'shell_search' %}
<script type="text/javascript">
//<![CDATA[
var shell_history = {
    'commands': {{ command_history|safe }}
};
shell_history['index'] = shell_history['commands'].length;
var shell_results_url = "{% url 'servershell_results' %}";
var shell_export_url = "{% url 'servershell_export' %}";
var shell_list_url = "{% url 'servershell_list' %}";
var shell_commit_url = "{% url 'servershell_commit' %}";
var shell_values_url = "{% url 'servershell_values' %}";
var shell_new_url = "{% url 'servershell_new' %}";
var shell_compare_url = "{% url 'servermonitor_compare' %}";
var shell_graph_url = "{% url 'servermonitor_graph_table' %}";
var shell_custom_graph_url = "{% url 'servermonitor_custom_graph_table' %}";
var shell_custom_cmp_url= "{% url 'servermonitor_custom_compare' %}";
var shell_livegraph_url = "{% url 'servermonitor_livegraph' %}";
var shell_changes_url = "{% url 'serverdb_changes' %}";
var shell_store_command_url = "{% url 'servershell_store_command' %}";
var livegraph_url = "{% url 'servermonitor_livegraph_data' %}";
var monitor_reload_url = "{% url 'servermonitor_reload' %}";
var serverdb_history_url = "{% url 'serverdb_history' %}";
//]]>
</script>
<script type="text/javascript" src="{{ STATIC_URL }}servershell/common.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}servershell/servershell.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}servermonitor/servermonitor.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}flot/jquery.flot.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}servermonitor/livegraph.js"></script>
<script type="text/javascript">
//<![CDATA[
search['per_page'] = {{ per_page }};
//]]>
</script>
{% endblock %}
